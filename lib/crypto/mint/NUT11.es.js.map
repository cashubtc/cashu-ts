{"version":3,"file":"NUT11.es.js","sources":["../../../src/crypto/mint/NUT11.ts"],"sourcesContent":["import { schnorr } from '@noble/curves/secp256k1';\nimport { sha256 } from '@noble/hashes/sha256';\nimport { parseSecret } from '../common/NUT10';\nimport {\n\tgetP2PKExpectedKWitnessPubkeys,\n\tgetP2PKWitnessSignatures,\n\tgetP2PKNSigs,\n\tverifyP2PKSecretSignature,\n} from '../client/NUT11';\nimport { P2PKWitness, type Proof } from '../../model/types/index';\nimport { type BlindedMessage } from '../client/index';\n\nexport const verifyP2PKSig = (proof: Proof): boolean => {\n\tif (!proof.witness) {\n\t\tthrow new Error('could not verify signature, no witness provided');\n\t}\n\tconst parsedSecret = parseSecret(proof.secret);\n\tconst witnesses = getP2PKExpectedKWitnessPubkeys(parsedSecret);\n\tif (!witnesses.length) {\n\t\tthrow new Error('no signatures required, proof is unlocked');\n\t}\n\tlet signatories = 0;\n\tconst requiredSigs = getP2PKNSigs(parsedSecret);\n\tconst signatures = getP2PKWitnessSignatures(proof.witness as string | P2PKWitness | undefined);\n\t// Loop through witnesses to see if any of the signatures belong to them.\n\t// We need to do this as Schnorr signatures are non-deterministic, so we\n\t// count the number of valid witnesses, not the number of valid signatures\n\tfor (const pubkey of witnesses) {\n\t\tconst hasSigned = signatures.some((sig) => {\n\t\t\ttry {\n\t\t\t\treturn verifyP2PKSecretSignature(sig, proof.secret, pubkey);\n\t\t\t} catch {\n\t\t\t\treturn false; // Invalid signature, treat as not signed\n\t\t\t}\n\t\t});\n\t\tif (hasSigned) {\n\t\t\tsignatories++;\n\t\t}\n\t}\n\tif (signatories >= requiredSigs) {\n\t\treturn true;\n\t}\n\treturn false;\n};\n\nexport const verifyP2PKSigOutput = (output: BlindedMessage, publicKey: string): boolean => {\n\tif (!output.witness) {\n\t\tthrow new Error('could not verify signature, no witness provided');\n\t}\n\treturn schnorr.verify(\n\t\toutput.witness.signatures[0],\n\t\tsha256(output.B_.toHex(true)),\n\t\tpublicKey.slice(2),\n\t);\n};\n"],"names":["verifyP2PKSig","proof","parsedSecret","parseSecret","witnesses","getP2PKExpectedKWitnessPubkeys","signatories","requiredSigs","getP2PKNSigs","signatures","getP2PKWitnessSignatures","pubkey","sig","verifyP2PKSecretSignature","verifyP2PKSigOutput","output","publicKey","schnorr","sha256"],"mappings":";;;;AAYO,MAAMA,IAAgB,CAACC,MAA0B;AACvD,MAAI,CAACA,EAAM;AACV,UAAM,IAAI,MAAM,iDAAiD;AAElE,QAAMC,IAAeC,EAAYF,EAAM,MAAM,GACvCG,IAAYC,EAA+BH,CAAY;AAC7D,MAAI,CAACE,EAAU;AACd,UAAM,IAAI,MAAM,2CAA2C;AAE5D,MAAIE,IAAc;AAClB,QAAMC,IAAeC,EAAaN,CAAY,GACxCO,IAAaC,EAAyBT,EAAM,OAA2C;AAI7F,aAAWU,KAAUP;AAQpB,IAPkBK,EAAW,KAAK,CAACG,MAAQ;AAC1C,UAAI;AACH,eAAOC,EAA0BD,GAAKX,EAAM,QAAQU,CAAM;AAAA,MAC3D,QAAQ;AACP,eAAO;AAAA,MACR;AAAA,IACD,CAAC,KAEAL;AAGF,SAAIA,KAAeC;AAIpB,GAEaO,IAAsB,CAACC,GAAwBC,MAA+B;AAC1F,MAAI,CAACD,EAAO;AACX,UAAM,IAAI,MAAM,iDAAiD;AAElE,SAAOE,EAAQ;AAAA,IACdF,EAAO,QAAQ,WAAW,CAAC;AAAA,IAC3BG,EAAOH,EAAO,GAAG,MAAM,EAAI,CAAC;AAAA,IAC5BC,EAAU,MAAM,CAAC;AAAA,EAAA;AAEnB;"}